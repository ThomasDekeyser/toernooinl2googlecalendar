<?xml version="1.0" encoding="UTF-8"?>

<config>
	<var-def name="baseUrlToernooiNlGentse"><template><![CDATA[http://www.toernooi.nl/sport/clubmatches.aspx?id=${competitionId}&cid=${clubId}]]></template></var-def>
	<var-def name="baseUrlToernooiNlMatch"><template><![CDATA[http://www.toernooi.nl/sport/teammatch.aspx?id=${competitionId}&match=]]></template></var-def>
	<var-def name="baseUrlToernooiNlLocation"><template><![CDATA[http://www.toernooi.nl/sport/location.aspx?id=${competitionId}&lid=]]></template></var-def>		
	

	<file action="write" path="/tmp/abc3.xml" charset="UTF-8">
		<html-to-xml>
			<http method="post" url="${baseUrlToernooiNlGentse}">
<http-param name="__EVENTTARGET">ctl00%24ctl00%24ctl00%24ctl00%24cphPage%24cphPage%24cphPage%24cphPage%24dlFilter</http-param>
<http-param name="__VIEWSTATE">/wEPDwUINDU2MDcwODFkZA==</http-param>
<http-param name="__EVENTVALIDATION">/wEWDwLpmtW1DALl6JmnDALm6JmnDALy6JmnDALl6OGkDAL784NIAvCAzPIGAvzv5pwKAuDv5pwKAv7vkp8KAv7vlp8KAv/v5pwKAv7v5pwKAvvv5pwKAvrv5pwK</http-param>
<http-param name="ctl00$ctl00$ctl00$ctl00$cphPage$ddlSearchType">1</http-param>
<http-param name="ctl00$ctl00$ctl00$ctl00$cphPage$cphPage$cphPage$cphPage$dlFilter">0</http-param>										
			</http>			
		</html-to-xml>		
	</file>

	<var-def name="calTmp1">
	        <template><![CDATA[ <?xml version="1.0" encoding="UTF-8"?> <cals  time="${sys.datetime("yyyy-MM-dd HH:mm:ss")}"> ]]></template>
	        	
				<xquery>
					<xq-param name="doc">
						<html-to-xml>
							<http method="post" url="${baseUrlToernooiNlGentse}">
								<http-param name="__EVENTTARGET">ctl00%24ctl00%24ctl00%24ctl00%24cphPage%24cphPage%24cphPage%24cphPage%24dlFilter</http-param>
								<http-param name="__VIEWSTATE">/wEPDwUINDU2MDcwODFkZA==</http-param>
								<http-param name="__EVENTVALIDATION">/wEWDwLpmtW1DALl6JmnDALm6JmnDALy6JmnDALl6OGkDAL784NIAvCAzPIGAvzv5pwKAuDv5pwKAv7vkp8KAv7vlp8KAv/v5pwKAv7v5pwKAvvv5pwKAvrv5pwK</http-param>
								<http-param name="ctl00$ctl00$ctl00$ctl00$cphPage$ddlSearchType">1</http-param>
								<http-param name="ctl00$ctl00$ctl00$ctl00$cphPage$cphPage$cphPage$cphPage$dlFilter">0</http-param>																	
							</http>
						</html-to-xml>
					</xq-param>
					<xq-expression><![CDATA[
						declare variable $doc as node() external;
						for $record in $doc//table[@class="ruler"]/tbody/tr
							let $myDate := substring-after(normalize-space(data($record/td[2])),' ')
							let $myYear := substring-before(substring-after(substring-after($myDate,'-'),'-'),' ')
							let $myMonth := substring-before(substring-after($myDate,'-'),'-')
							let $myDay := substring-before($myDate,'-')
							let $myHour := substring-before(substring-after($myDate,' '),':')
							let $myMinute := substring-after(substring-after($myDate,' '),':')
							let $myHourPlus := number($myHour) + 3
							let $home := concat(normalize-space(data($record/td[7]/a[starts-with(@href,'teammatch.aspx')])),normalize-space(data($record/td[7]/strong/a[starts-with(@href,'teammatch.aspx')])))
							let $out :=  concat(normalize-space(data($record/td[9]/a[starts-with(@href,'teammatch.aspx')])),normalize-space(data($record/td[9]/strong/a[starts-with(@href,'teammatch.aspx')])))
							return
								<cal>
									<home>{$home}</home>
									<out>{$out}</out>
									<subject>{$home} - {$out}</subject>
									<startdate>{$myDay}/{$myMonth}/{$myYear}</startdate>
									<starttime>{$myHour}:{$myMinute}:00</starttime>
									<endtime>{$myHourPlus}:{$myMinute}:00</endtime>
									<id>{substring-after(normalize-space(data($record/td[7]/a[starts-with(@href,'teammatch.aspx')]/@href)),'match=')}{substring-after(normalize-space(data($record/td[7]/strong/a[starts-with(@href,'teammatch.aspx')]/@href)),'match=')}</id>
								</cal>
					]]></xq-expression>
				</xquery>
			 <template><![CDATA[ </cals> ]]></template>
	</var-def>
	
	<var-def name="gentseTeams">
			<template><![CDATA[ <?xml version="1.0" encoding="UTF-8"?> <teams  time="${sys.datetime("yyyy-MM-dd HH:mm:ss")}"> ]]></template>
		    <loop item="team" index="i" filter="unique">
		        <list>
		            <xpath expression="/cals/cal/home[starts-with(text(),'Gentse')]/text()|/cals/cal/out[starts-with(text(),'Gentse')]/text()">
		                <var name="calTmp1"/>
		            </xpath>
		        </list>
		        <body>
		        		<template><![CDATA[ <team>${team}</team> ]]></template>
		        </body>
		     </loop>
		     <template><![CDATA[ </teams> ]]></template>		
	</var-def>
	<file action="write" path="${eventsXML}">
		<template><![CDATA[ <?xml version="1.0" encoding="UTF-8"?> <teams time="${sys.datetime("yyyy/MM/dd HH:mm:ss")}"> ]]></template>
		<loop item="team" index="j">
			<list>
			    <xpath expression="//team">
			        <var name="gentseTeams"/>
			    </xpath>			
			</list>
			<body>
				<empty>
						<var-def name="myTeam">
			                <xpath expression="/team/text()">
			                    <var name="team"/>
			                </xpath>						
						</var-def>
				</empty>
				<template><![CDATA[ <team name="${myTeam}">]]></template>
			    <loop item="cal" index="i">				    	
			        <list>
			            <xpath expression="//cal[home='${myTeam}']|//cal[out='${myTeam}']">
			                <var name="calTmp1"/>
			            </xpath>
			        </list>
			        <body>
			        	<empty>
				            <var-def name="mySubject">
				                <xpath expression="/cal/subject/text()">
				                    <var name="cal"/>
				                </xpath>
				            </var-def>
				            <var-def name="myStartDate">
				                <xpath expression="/cal/startdate/text()">
				                    <var name="cal"/>
				                </xpath>
				            </var-def>
				            <var-def name="myStartTime">
				                <xpath expression="/cal/starttime/text()">
				                    <var name="cal"/>
				                </xpath>
				            </var-def>
				            <var-def name="myEndTime">
				                <xpath expression="/cal/endtime/text()">
				                    <var name="cal"/>
				                </xpath>
				            </var-def>
				            		        			
				            <var-def name="myLine">
				                <xpath expression="concat(/cal/subject/text(),',',/cal/startdate/text(),',',/cal/starttime/text(),'YYY')">
				                    <var name="cal"/>
				                </xpath>
				            </var-def>
				            <var-def name="myMatchId">
				                <xpath expression="/cal/id/text()">
				                    <var name="cal"/>
				                </xpath>
				            </var-def>	            
				            <var-def name="myLocationIdDoc">
								<html-to-xml>
									<http url="${baseUrlToernooiNlMatch}${myMatchId}"/>
								</html-to-xml>			            	
				            </var-def>
				            <var-def name="myLocationId">
				            	<xpath expression="substring-after(normalize-space(//table/tbody/tr[./th='Locatie:']/td/a/@href),'lid=')">
				            		<var name="myLocationIdDoc"/>
				            	</xpath>
				            </var-def>
				            <var-def name="myLocationDoc">
								<html-to-xml>
									<http url="${baseUrlToernooiNlLocation}${myLocationId}"/>
								</html-to-xml>			            	
				            </var-def>
				            <var-def name="myLocation">
		   		            	<xpath expression="concat(normalize-space(substring-after(//div/h3[starts-with(text(),'Locatie:')]/text(),'Locatie:')),', ',normalize-space(//table/tbody/tr[th =  'Adres:']/td/text()[1]),', ',normalize-space(//table/tbody/tr[th =  'Adres:']/td/text()[2]))">
		   		            		<var name="myLocationDoc"/>
		   		            	</xpath>			            			            	
				            </var-def>
			            </empty>
			            <template><![CDATA[<event><subject>${mySubject}</subject><startDate>${myStartDate}</startDate><startTime>${myStartTime}</startTime><endTime>${myEndTime}</endTime><location>${myLocation}</location></event>]]></template>
			        </body>
			    </loop><!-- loop over matches -->
   				<template><![CDATA[ </team> ]]></template>
			</body>
		</loop><!-- loop over teams -->
		<template><![CDATA[ </teams> ]]></template>
	</file>	
</config>
